<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{% block title %}TIDE{% endblock %}</title>
    
    <!-- Brand Hue Override from .env -->
    <style>
        :root {
            --brand-hue: {{ brand_hue | default(240) }};
        }
    </style>
    
    <!-- Tailwind CSS with cache busting -->
    <link rel="stylesheet" href="/static/css/dist/styles.css?v={{ cache_bust | default(range(1, 99999) | random) }}">
    <!-- Additional overrides -->
    <style>
        /* ========================================
         * CYBER THEME - Elevation = Lightness
         * Hue: 240 (Cyber blue-grey)
         * L values: base=0.16, surface=0.20, raised=0.24, overlay=0.28
         * ======================================== */
        :root {
            --hue: var(--brand-hue, 240);
            --hue-secondary: calc(var(--hue) + 180);
            --chroma: 0.04;
            --chroma-surface: calc(var(--chroma) * 0.6);
            --chroma-text: 0.02;
            --chroma-action: 0.14;
            --chroma-alert: 0.16;
            
            /* Elevation Surfaces (Lightness increases with elevation) */
            --surface-base: oklch(0.16 var(--chroma-surface) var(--hue));
            --surface-base-alt: oklch(0.18 var(--chroma-surface) var(--hue));
            --surface-1: oklch(0.20 var(--chroma-surface) var(--hue));
            --surface-1-hover: oklch(0.22 var(--chroma-surface) var(--hue));
            --surface-2: oklch(0.24 var(--chroma-surface) var(--hue));
            --surface-2-hover: oklch(0.28 var(--chroma-surface) var(--hue));
            --surface-3: oklch(0.28 var(--chroma-surface) var(--hue));
            
            /* Legacy mappings for compatibility */
            --color-bg-darkest: var(--surface-base);
            --color-bg-dark: var(--surface-base-alt);
            --color-bg: var(--surface-1);
            --color-bg-light: var(--surface-1-hover);
            --color-bg-lighter: var(--surface-2);
            --color-bg-elevated: var(--surface-3);
            
            /* Text - High contrast (L > 0.90 for primary) */
            --color-text: oklch(0.96 var(--chroma-text) var(--hue));
            --color-text-secondary: oklch(0.78 var(--chroma-text) var(--hue));
            --color-text-muted: oklch(0.58 var(--chroma-text) var(--hue));
            
            /* Borders */
            --color-border: oklch(0.35 var(--chroma) var(--hue));
            --color-border-muted: oklch(0.28 var(--chroma) var(--hue));
            --color-border-strong: oklch(0.45 var(--chroma) var(--hue));
            --color-highlight: oklch(0.40 var(--chroma) var(--hue));
            
            /* Primary/Secondary */
            --color-primary: oklch(0.72 var(--chroma-action) var(--hue));
            --color-primary-hover: oklch(0.80 var(--chroma-action) var(--hue));
            --color-primary-muted: oklch(0.42 calc(var(--chroma-action) * 0.5) var(--hue));
            --color-secondary: oklch(0.72 var(--chroma-action) var(--hue-secondary));
            
            /* Semantic colors - High visibility */
            --color-success: oklch(0.72 var(--chroma-alert) 150);
            --color-success-bg: oklch(0.20 calc(var(--chroma-alert) * 0.5) 150);
            --color-success-text: oklch(0.92 var(--chroma-alert) 150);
            --color-warning: oklch(0.78 var(--chroma-alert) 55);
            --color-warning-bg: oklch(0.20 calc(var(--chroma-alert) * 0.5) 55);
            --color-warning-text: oklch(0.94 var(--chroma-alert) 55);
            --color-danger: oklch(0.68 var(--chroma-alert) 28);
            --color-danger-bg: oklch(0.20 calc(var(--chroma-alert) * 0.5) 28);
            --color-danger-text: oklch(0.92 var(--chroma-alert) 28);
            --color-info: oklch(0.72 var(--chroma-alert) 230);
            --color-info-bg: oklch(0.20 calc(var(--chroma-alert) * 0.5) 230);
            --color-info-text: oklch(0.92 var(--chroma-alert) 230);
            
            /* Gradients */
            --gradient: linear-gradient(180deg, var(--surface-1-hover), var(--surface-1));
            --gradient-hover: linear-gradient(180deg, var(--surface-2), var(--surface-1-hover));
        }
        
        /* ========================================
         * LIGHT THEME - Inverted Elevation
         * ======================================== */
        body.light {
            --surface-base: oklch(0.96 var(--chroma-surface) var(--hue));
            --surface-base-alt: oklch(0.94 var(--chroma-surface) var(--hue));
            --surface-1: oklch(0.99 var(--chroma-surface) var(--hue));
            --surface-1-hover: oklch(0.97 var(--chroma-surface) var(--hue));
            --surface-2: oklch(1.00 var(--chroma-surface) var(--hue));
            --surface-2-hover: oklch(0.98 var(--chroma-surface) var(--hue));
            --surface-3: oklch(1.00 var(--chroma-surface) var(--hue));
            
            --color-bg-darkest: var(--surface-base);
            --color-bg-dark: var(--surface-base-alt);
            --color-bg: var(--surface-1);
            --color-bg-light: var(--surface-1-hover);
            --color-bg-lighter: var(--surface-2);
            --color-bg-elevated: var(--surface-3);
            
            --color-text: oklch(0.15 var(--chroma-text) var(--hue));
            --color-text-secondary: oklch(0.35 var(--chroma-text) var(--hue));
            --color-text-muted: oklch(0.50 var(--chroma-text) var(--hue));
            
            --color-border: oklch(0.80 var(--chroma) var(--hue));
            --color-border-muted: oklch(0.85 var(--chroma) var(--hue));
            --color-border-strong: oklch(0.5 var(--chroma) var(--hue));
            --color-highlight: oklch(1.00 var(--chroma) var(--hue));
            
            --color-primary: oklch(0.48 var(--chroma-action) var(--hue));
            --color-primary-hover: oklch(0.40 var(--chroma-action) var(--hue));
            --color-primary-muted: oklch(0.70 calc(var(--chroma-action) * 0.5) var(--hue));
            --color-secondary: oklch(0.48 var(--chroma-action) var(--hue-secondary));
            
            --color-success: oklch(0.48 var(--chroma-alert) 150);
            --color-success-bg: oklch(0.90 calc(var(--chroma-alert) * 0.3) 150);
            --color-warning: oklch(0.58 var(--chroma-alert) 55);
            --color-warning-bg: oklch(0.90 calc(var(--chroma-alert) * 0.3) 55);
            --color-danger: oklch(0.52 var(--chroma-alert) 28);
            --color-danger-bg: oklch(0.90 calc(var(--chroma-alert) * 0.3) 28);
            --color-info: oklch(0.52 var(--chroma-alert) 230);
            --color-info-bg: oklch(0.90 calc(var(--chroma-alert) * 0.3) 230);
        }
        
        /* ========================================
         * SIDEBAR - Disable hover expand, use toggle only
         * ======================================== */
        .sidebar {
            width: var(--sidebar-width-collapsed) !important;
        }
        .sidebar:hover {
            width: var(--sidebar-width-collapsed) !important;
        }
        .sidebar:hover .sidebar-title,
        .sidebar:hover .nav-label {
            opacity: 0 !important;
        }
        .app-layout:has(.sidebar:hover) .main-content {
            margin-left: var(--sidebar-width-collapsed) !important;
        }
        
        /* Toggle-based expansion */
        .sidebar.expanded {
            width: var(--sidebar-width-expanded) !important;
        }
        .sidebar.expanded .sidebar-title,
        .sidebar.expanded .nav-label {
            opacity: 1 !important;
        }
        .app-layout:has(.sidebar.expanded) .main-content {
            margin-left: var(--sidebar-width-expanded) !important;
        }
        
        /* ========================================
         * SIDEBAR FOOTER - Fix alignment
         * ======================================== */
        .sidebar-footer {
            padding: 0.5rem;
            border-top: var(--border-card);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .sidebar-footer .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--radius-md);
        }
        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-primary-muted);
            color: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        /* ========================================
         * SVG ICONS - Primary color
         * ======================================== */
        .nav-icon-svg {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
            stroke: var(--color-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.8;
            transition: opacity 0.15s ease;
        }
        .nav-item:hover .nav-icon-svg {
            opacity: 1;
        }
        .nav-item.active .nav-icon-svg {
            opacity: 1;
            stroke: var(--color-primary);
        }
        
        /* User menu dropdown */
        .user-menu-container {
            position: relative;
        }
        .user-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--surface-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: none;
            z-index: 200;
            min-width: 180px;
        }
        .user-menu.show {
            display: block;
        }
        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }
        .user-menu-item:hover {
            background: var(--surface-2);
            color: var(--color-text);
        }
        .user-menu-item svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }
        .user-menu-divider {
            height: 1px;
            background: var(--color-border-muted);
            margin: 0.5rem 0;
        }
        
        /* Tooltip for collapsed sidebar - OVERRIDE global tooltip */
        /* Disable the global tooltip ::before and ::after for sidebar nav-items */
        .sidebar .nav-item[data-tooltip]::before {
            display: none !important;
            content: none !important;
        }
        /* Reset global ::after styles so our sidebar tooltip works */
        .sidebar .nav-item[data-tooltip]::after {
            /* These reset the global tooltip positioning */
            bottom: auto !important;
            border: none !important;
            border-top-color: transparent !important;
        }
        .sidebar:not(.expanded) .nav-item[data-tooltip] {
            position: relative;
        }
        .sidebar:not(.expanded) .nav-item[data-tooltip]::after {
            content: attr(data-tooltip) !important;
            position: absolute !important;
            left: calc(100% + 10px) !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background: var(--surface-3) !important;
            border: 1px solid var(--color-border) !important;
            color: var(--color-text) !important;
            padding: 0.5rem 0.75rem !important;
            border-radius: var(--radius-md) !important;
            font-size: 0.875rem !important;
            white-space: nowrap !important;
            opacity: 0 !important;
            visibility: hidden !important;
            transition: all 0.15s ease !important;
            z-index: 9999 !important;
            box-shadow: var(--shadow) !important;
            pointer-events: none !important;
        }
        .sidebar:not(.expanded) .nav-item[data-tooltip]:hover::after {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Nav item button styles */
        .nav-item {
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font: inherit;
        }
        
        /* ========================================
         * THREAT CARDS
         * ======================================== */
        .threats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        @media (max-width: 1200px) {
            .threats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .threats-grid { grid-template-columns: 1fr; }
        }
        
        .threat-card {
            background: var(--gradient);
            border: var(--border-card);
            border-top: 1px solid var(--color-highlight);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            min-height: 320px;
            box-shadow: var(--shadow);
            transition: all 0.15s ease;
        }
        .threat-card:hover {
            background: var(--gradient-hover);
            border-color: var(--color-border-strong);
            transform: translateY(-2px);
        }
        
        /* Actor header: flag + name + pills */
        .threat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .threat-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 0;
        }
        .actor-flag-icon {
            width: 24px;
            height: 18px;
            border-radius: 2px;
            flex-shrink: 0;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
        }
        .actor-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--color-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        /* Source pills - in header on right */
        .source-pills {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.15rem;
            flex-shrink: 0;
        }
        .source-pill {
            font-size: 0.6rem;
            padding: 0.1rem 0.25rem;
            border-radius: var(--radius-sm);
            background: var(--surface-2);
            color: var(--color-text-muted);
            border: 1px solid var(--color-border-muted);
            font-weight: 600;
            text-transform: uppercase;
        }
        .source-pill.src-enterprise {
            background: var(--color-info-bg);
            border-color: var(--color-info);
            color: var(--color-info);
        }
        .source-pill.src-ics {
            background: var(--color-warning-bg);
            border-color: var(--color-warning);
            color: var(--color-warning);
        }
        .source-pill.src-mobile {
            background: var(--color-primary-muted);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        .source-pill.src-pre {
            background: var(--color-danger-bg);
            border-color: var(--color-danger);
            color: var(--color-danger);
        }
        .source-pill.src-opencti {
            background: var(--color-success-bg);
            border-color: var(--color-success);
            color: var(--color-success);
        }
        
        /* Aliases */
        .threat-aliases {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            font-style: italic;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Description */
        .threat-desc {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            margin-bottom: 0.75rem;
        }
        
        /* Coverage section at bottom */
        .threat-coverage {
            margin-top: auto;
        }
        .coverage-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-bottom: 0.35rem;
        }
        .coverage-value {
            font-weight: 600;
        }
        .coverage-track {
            height: 5px;
            background: var(--surface-base);
            border-radius: 999px;
            overflow: hidden;
        }
        .coverage-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.25s ease;
        }
        
        /* Rule Card Header - Name left, pills stacked right */
        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .rule-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-text);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            flex: 1;
            min-width: 0;
        }
        .rule-pills-stack {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
            flex-shrink: 0;
            min-width: 90px;
        }
        .rule-pills-stack .status-pill,
        .rule-pills-stack .sev-pill {
            align-self: flex-end;
        }
        .mitre-pills-row {
            display: flex;
            justify-content: flex-end;
            flex-wrap: wrap;
            gap: 0.2rem;
            cursor: default;
        }
        .mitre-pills-row .mitre-pill {
            font-size: 0.6rem;
            padding: 0.15rem 0.35rem;
        }
        
        /* Rule Card Pills */
        .status-pill, .sev-pill, .mitre-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            font-size: 0.65rem;
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-align: center;
            min-height: 22px;
            box-sizing: border-box;
        }
        .status-pill {
            flex-shrink: 0;
        }
        .status-pill.status-enabled {
            background-color: var(--color-success-bg);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }
        .status-pill.status-disabled {
            background-color: var(--surface-2);
            color: var(--color-text-muted);
            border: 1px solid var(--color-border-muted);
        }
        .status-icon {
            width: 11px;
            height: 11px;
            flex-shrink: 0;
        }
        .sev-pill {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: var(--surface-base) !important;
            text-transform: uppercase;
            align-self: flex-start;
            border: 1px solid rgba(0,0,0,0.2) !important;
            min-height: 22px !important;
            padding: 0.2rem 0.5rem !important;
            font-size: 0.65rem !important;
            font-weight: 700 !important;
            box-sizing: border-box !important;
        }
        .mitre-pill {
            background-color: var(--surface-2);
            color: var(--color-text-muted);
            border: 1px solid var(--color-border-muted);
        }
        .mitre-more, .mitre-none {
            background-color: var(--surface-2);
            color: var(--color-text-muted);
            border: 1px solid var(--color-border-muted);
        }
        .mitre-none {
            font-style: italic;
            font-weight: 400;
        }
        
        /* Meta Row - consistent key:value spacing */
        .meta-row {
            display: flex;
            gap: 0.5rem;
        }
        .meta-row .meta-label {
            flex-shrink: 0;
        }
        .meta-row .meta-val {
            flex: 1;
            text-align: right;
        }
        .meta-left .meta-row .meta-val {
            text-align: left;
        }
        .meta-item {
            display: flex;
            gap: 0.35rem;
        }
        .meta-item .meta-val {
            text-align: left;
        }
        .meta-right {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        
        /* TTP Expander */
        .ttp-expander {
            margin-top: 0.75rem;
            border-top: 1px solid var(--color-border-muted);
            padding-top: 0.5rem;
        }
        .ttp-expander[open] {
            position: relative;
            z-index: 10;
            background: var(--surface-1);
            margin: 0.75rem -1rem -1rem -1rem;
            padding: 0.5rem 1rem 1rem 1rem;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            border-top: 1px solid var(--color-border-muted);
            box-shadow: 0 4px 16px oklch(0 0 0 / 0.3);
        }
        .ttp-summary {
            cursor: pointer;
            color: var(--color-text-muted);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            list-style: none;
        }
        .ttp-summary::-webkit-details-marker {
            display: none;
        }
        .ttp-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
            max-height: 120px;
            overflow-y: auto;
            padding-right: 0.25rem;
        }
        .ttp-list::-webkit-scrollbar {
            width: 4px;
        }
        .ttp-list::-webkit-scrollbar-track {
            background: var(--surface-1);
            border-radius: 2px;
        }
        .ttp-list::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 2px;
        }
        .ttp-tag {
            font-size: 0.625rem;
            padding: 0.2rem 0.4rem;
            border-radius: var(--radius-sm);
            font-family: monospace;
        }
        .ttp-covered {
            background-color: var(--color-success-bg);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }
        .ttp-gap {
            background-color: var(--color-danger-bg);
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
        }
        .expand-chevron {
            width: 14px;
            height: 14px;
            opacity: 0.7;
            transition: transform 0.15s ease;
            transform: rotate(90deg);
        }
        .ttp-expander[open] .expand-chevron {
            transform: rotate(-90deg);
        }
        
        /* ========================================
         * HTMX LOADING STATES
         * ======================================== */
        .htmx-request {
            cursor: wait;
        }
        .htmx-request .main-content {
            opacity: 0.7;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        
        /* Toast styles */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            background: var(--surface-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-success {
            border-left: 3px solid var(--color-success);
        }
        .toast-error {
            border-left: 3px solid var(--color-danger);
        }
        .toast-warning {
            border-left: 3px solid var(--color-warning);
        }
        .toast-info {
            border-left: 3px solid var(--color-info);
        }
    </style>
    
    <!-- HTMX Core + Head Support Extension -->
    <script src="/static/js/htmx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/htmx-ext-head-support@2.0.5/dist/head-support.min.js"></script>
    
    <!-- TIDE Application JavaScript -->
    <script src="/static/js/app.js?v={{ cache_bust | default(range(1, 99999) | random) }}"></script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/icons/tide.png">
    
    {% block head %}{% endblock %}
</head>
<body hx-boost="true" hx-ext="head-support">
    <!-- App Layout Container -->
    <div class="app-layout">
        <!-- Sidebar -->
        {% include "components/sidebar.html" %}
        
        <!-- Main Content Area -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    {% block scripts %}{% endblock %}
</body>
</html>
