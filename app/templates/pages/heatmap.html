{% extends "base.html" %}

{% block title %}Heatmap | TIDE{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title-hero">
        Coverage Heatmap
    </h1>
    <p class="page-subtitle">Visualize your detection coverage against adversary techniques used by tracked threat actors.</p>
</div>

<!-- Metrics Row (populated via heatmap_matrix.html OOB swap) -->
<div class="metrics-grid" id="heatmap-metrics"></div>

<!-- Filters Bar -->
<div class="filters-bar">
    <!-- Technique Search -->
    <div class="filter-group grow" style="min-width: 200px; max-width: 300px;">
        <input 
            type="text" 
            id="technique-search"
            class="form-input" 
            placeholder="T1059, Command, Execution..."
            oninput="filterHeatmapTechniques(this.value)">
    </div>
    
    <!-- Actor Search -->
    <div class="filter-group grow" style="min-width: 200px; max-width: 300px;">
        <label class="form-label">Search Actors</label>
        <input 
            type="text" 
            id="actor-search"
            class="form-input" 
            placeholder="Name or alias..."
            oninput="filterActorCheckboxes(this.value)">
    </div>
    
    <!-- Actor Selection Dropdown -->
    <div class="filter-group grow" style="min-width: 250px; max-width: 350px;">
        <label class="form-label">Select Adversaries</label>
        <div class="actor-select-container" id="actor-select-container">
            <div class="actor-select-trigger" onclick="toggleActorDropdown()">
                <span class="actor-select-text" id="actor-select-text">Choose threat actors...</span>
                <svg class="actor-select-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m6 9 6 6 6-6"/>
                </svg>
            </div>
            <div class="actor-select-dropdown" id="actor-dropdown">
                <div class="actor-checkbox-list" id="actor-checkbox-list">
                    {% for actor in actors %}
                    <label class="actor-checkbox-item" data-name="{{ actor.name | lower }}" data-aliases="{{ (actor.aliases or '') | lower }}">
                        <input 
                            type="checkbox" 
                            name="actors" 
                            value="{{ actor.name }}"
                            onchange="updateActorSelection(); triggerHeatmapUpdate();">
                        <span class="actor-checkbox-label">{{ actor.name }}</span>
                        <span class="actor-checkbox-count">{{ actor.ttp_count }} TTPs</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Options -->
    <div class="filter-group">
        <label class="form-label">Options</label>
        <label class="actor-checkbox-item" style="padding: 0.5rem 0;">
            <input 
                type="checkbox" 
                name="show_defense"
                id="show-defense-checkbox"
                onchange="triggerHeatmapUpdate();">
            <span>Show Defense in Depth</span>
        </label>
    </div>
</div>

<script>
function toggleActorDropdown() {
    const container = document.getElementById('actor-select-container');
    const dropdown = document.getElementById('actor-dropdown');
    const isOpen = container.classList.toggle('open');
    // Toggle inline style for reliability
    dropdown.style.display = isOpen ? 'flex' : 'none';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const container = document.getElementById('actor-select-container');
    const dropdown = document.getElementById('actor-dropdown');
    if (container && !container.contains(e.target)) {
        container.classList.remove('open');
        if (dropdown) dropdown.style.display = 'none';
    }
});

function filterActorCheckboxes(query) {
    const lowerQuery = query.toLowerCase();
    const items = document.querySelectorAll('.actor-checkbox-item');
    items.forEach(item => {
        const name = item.dataset.name || '';
        const aliases = item.dataset.aliases || '';
        const matches = name.includes(lowerQuery) || aliases.includes(lowerQuery);
        item.style.display = matches ? 'flex' : 'none';
    });
}

function updateActorSelection() {
    const checked = document.querySelectorAll('input[name="actors"]:checked');
    const textEl = document.getElementById('actor-select-text');
    
    if (checked.length === 0) {
        textEl.textContent = 'Choose threat actors...';
        textEl.classList.remove('has-selection');
    } else if (checked.length === 1) {
        textEl.textContent = checked[0].value;
        textEl.classList.add('has-selection');
    } else {
        textEl.textContent = `${checked.length} actors selected`;
        textEl.classList.add('has-selection');
    }
}

function triggerHeatmapUpdate() {
    const checked = document.querySelectorAll('input[name="actors"]:checked');
    const showDefense = document.getElementById('show-defense-checkbox').checked;
    
    const actors = Array.from(checked).map(cb => cb.value);
    const params = new URLSearchParams();
    actors.forEach(a => params.append('actors', a));
    if (showDefense) params.append('show_defense', 'on');
    
    htmx.ajax('GET', '/api/heatmap/matrix?' + params.toString(), {
        target: '#heatmap-container',
        swap: 'innerHTML'
    });
}

// Filter techniques in the heatmap matrix by search query
function filterHeatmapTechniques(query) {
    const lowerQuery = query.toLowerCase().trim();
    const cells = document.querySelectorAll('.ttp-card');
    
    cells.forEach(cell => {
        if (!lowerQuery) {
            // Show all cells when search is empty
            cell.style.opacity = '1';
            cell.style.transform = '';
            cell.style.zIndex = '';
            cell.style.boxShadow = '';
            return;
        }
        
        const techId = (cell.dataset.techId || '').toLowerCase();
        const techName = (cell.dataset.techName || '').toLowerCase();
        const title = (cell.getAttribute('title') || '').toLowerCase();
        
        const matches = techId.includes(lowerQuery) || 
                       techName.includes(lowerQuery) || 
                       title.includes(lowerQuery);
        
        if (matches) {
            cell.style.opacity = '1';
            cell.style.transform = 'scale(1.08)';
            cell.style.zIndex = '10';
            cell.style.boxShadow = '0 0 8px var(--color-primary)';
        } else {
            cell.style.opacity = '0.2';
            cell.style.transform = '';
            cell.style.zIndex = '';
            cell.style.boxShadow = '';
        }
    });
}
</script>


<div class="divider"></div>

<!-- Heatmap Matrix -->
<div id="heatmap-container">
    {% include "partials/heatmap_matrix.html" %}
</div>

<!-- Slide Panel Container (for technique details) -->
<div id="slide-panel-container"></div>

{% endblock %}
