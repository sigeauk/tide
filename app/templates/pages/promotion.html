{% extends "base.html" %}
{% from "macros/icons.html" import icon, icon_text %}

{% block title %}Promotion | TIDE{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/heatmap.css?v={{ cache_bust }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title-hero">
        Rule Promotion
    </h1>
    <p class="page-subtitle">Promote validated detection rules from Staging to Production.</p>
</div>

<!-- Metrics Row -->
<div class="metrics-grid" id="promotion-metrics"
     hx-get="/api/promotion/metrics"
     hx-trigger="refreshPromotion from:body"
     hx-swap="innerHTML">
    {% include "partials/promotion_metrics.html" %}
</div>

<div class="divider"></div>

<!-- Filters Bar -->
<div class="filters-bar">
    <div class="filter-group grow">
        <label class="form-label">Search</label>
        <input 
            type="text" 
            name="search"
            class="form-input" 
            placeholder="Rule name, Author, ID, MITRE (T1078)..."
            hx-get="/api/promotion"
            hx-trigger="keyup changed delay:300ms"
            hx-target="#promotion-grid"
            hx-swap="innerHTML"
            hx-include="[name='enabled'], [name='sort_by']">
    </div>
    
    <div class="filter-group">
        <label class="form-label">Status</label>
        <select 
            name="enabled" 
            class="form-input form-select"
            hx-get="/api/promotion"
            hx-trigger="change"
            hx-target="#promotion-grid"
            hx-swap="innerHTML"
            hx-include="[name='search'], [name='sort_by']">
            <option value="">All</option>
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
        </select>
    </div>
    
    <div class="filter-group">
        <label class="form-label">Sort By</label>
        <select 
            name="sort_by" 
            class="form-input form-select"
            hx-get="/api/promotion"
            hx-trigger="change"
            hx-target="#promotion-grid"
            hx-swap="innerHTML"
            hx-include="[name='search'], [name='enabled']">
            <option value="score_asc">Score (Low ‚Üí High)</option>
            <option value="score_desc">Score (High ‚Üí Low)</option>
            <option value="name_asc">Name (A ‚Üí Z)</option>
        </select>
    </div>
    
    <div class="filter-group">
        <label class="form-label">&nbsp;</label>
        <button 
            class="btn btn-primary"
            hx-post="/api/promotion/sync"
            hx-target="#toast-container"
            hx-swap="beforeend">
            {{ icon_text('refresh-cw', 'Sync Rules', '16') }}
        </button>
    </div>
</div>

<!-- Promotion Grid - Load on page load via HTMX -->
<div id="promotion-grid"
     hx-get="/api/promotion"
     hx-trigger="load, refreshPromotion from:body"
     hx-swap="innerHTML">
    <div class="empty-state">
        <div class="loading-spinner"></div>
        <p>Loading staging rules...</p>
    </div>
</div>

<!-- Slide Panel Container for MITRE technique details -->
<div id="slide-panel-container"></div>

<!-- Modal Container -->
<div id="modal-container"></div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh page after promotion sync
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'promotion-grid') {
            htmx.ajax('GET', '/api/promotion/metrics', {target: '#promotion-metrics', swap: 'innerHTML'});
        }
    });
    
    // Toast auto-dismiss
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'toast-container') {
            const toasts = event.detail.target.querySelectorAll('.toast');
            toasts.forEach(function(toast) {
                setTimeout(function() {
                    toast.style.opacity = '0';
                    setTimeout(function() { toast.remove(); }, 300);
                }, 5000);
            });
        }
    });
    
    // Handle promotion confirmation modals
    function showPromoteConfirm(ruleId, ruleName) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.onclick = function(e) {
            if (e.target === modal) modal.remove();
        };
        modal.innerHTML = `
            <div class="modal-content modal-sm" onclick="event.stopPropagation()">
                <h2 class="modal-section-title">Promote to Production</h2>
                <p class="text-secondary mb-md">
                    Are you sure you want to promote <strong>${ruleName}</strong> to the Production environment?
                </p>
                <div class="alert alert-warning mb-md">
                    <p>
                        ‚ö†Ô∏è This will move the rule from Staging to Production and delete it from Staging.
                    </p>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                        Cancel
                    </button>
                    <button 
                        class="btn btn-primary"
                        onclick="promoteRule('${ruleId}', this)">
                        üöÄ Promote
                    </button>
                </div>
            </div>
        `;
        document.getElementById('modal-container').appendChild(modal);
    }
    
    // Actually perform the promotion via fetch
    function promoteRule(ruleId, btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Promoting...';
        
        fetch('/api/promotion/' + ruleId + '/promote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Close modal
            const modal = btn.closest('.modal-overlay');
            if (modal) modal.remove();
            
            // Add toast
            document.getElementById('toast-container').insertAdjacentHTML('beforeend', html);
            
            // Trigger refresh
            htmx.trigger(document.body, 'refreshPromotion');
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = 'üöÄ Promote';
            document.getElementById('toast-container').insertAdjacentHTML('beforeend', 
                '<div class="toast toast-danger" onclick="this.remove()">‚ùå Error: ' + err.message + '</div>');
        });
    }
</script>
{% endblock %}
