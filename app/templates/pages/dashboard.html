{% extends "base.html" %}
{% from "macros/icons.html" import icon, icon_text %}

{% block title %}Dashboard | TIDE{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; align-items: flex-start; justify-content: space-between;">
    <div>
        <h1 class="page-title-hero">Dashboard</h1>
        <p class="page-subtitle">Overview of your detection engineering posture across all modules.</p>
    </div>
    <div style="display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0;">
        <div id="sync-status"></div>
        <button type="button" class="btn btn-primary btn-sm"
                hx-post="/api/sync/elastic"
                hx-target="#sync-status"
                hx-swap="outerHTML">
            {{ icon('refresh-cw', '14') }}
            Sync Elastic
        </button>
    </div>
</div>

<!-- ═══ Rule Health Section ═══ -->
<div class="overview-section">
    <h2>{{ icon('shield-check', '20') }} Rule Health</h2>
    <div class="metrics-grid">
        {% set metrics = rule_metrics %}
        {% include "partials/metrics_row.html" %}
    </div>
</div>

<!-- ═══ Promotion Section ═══ -->
<div class="overview-section">
    <h2>{{ icon('circle-arrow-up', '20') }} Promotion</h2>
    <div class="metrics-grid">
        {% set metrics = promotion_metrics %}
        {% include "partials/promotion_metrics.html" %}
    </div>
</div>

<!-- ═══ Threat Landscape Section ═══ -->
<div class="overview-section">
    <h2>{{ icon('target', '20') }} Threat Landscape</h2>
    <div class="metrics-grid">
        {% set metrics = threat_metrics %}
        {% include "partials/threat_metrics.html" %}
    </div>
</div>

<!-- ═══ Connected Services ═══ -->
<div class="overview-section">
    <h2>{{ icon('settings', '20') }} Connected Services</h2>
    <div class="metrics-grid">
        <div class="integration-card">
            <div class="integration-card-name">Elasticsearch</div>
            <div class="integration-card-url">{{ env.elasticsearch_url }}</div>
            <span class="integration-card-status status-{{ 'active' if env.elastic_api_key else 'inactive' }}">{{ 'Connected' if env.elastic_api_key else 'No API Key' }}</span>
        </div>

        {% set spaces = env.kibana_spaces.split(',') %}
        {% for space_name in spaces %}
        {% set space = space_name.strip() %}
        <div class="integration-card">
            <div class="integration-card-name">Kibana ({{ space | capitalize }})</div>
            <div class="integration-card-url">{{ env.elastic_url }}/s/{{ space }}</div>
            <span class="integration-card-status status-{{ 'active' if env.elastic_api_key else 'inactive' }}">{{ 'Connected' if env.elastic_api_key else 'No API Key' }}</span>
        </div>
        {% endfor %}

        <div class="integration-card">
            <div class="integration-card-name">OpenCTI</div>
            <div class="integration-card-url">{{ env.opencti_url }}</div>
            <span class="integration-card-status status-{{ 'active' if env.opencti_token else 'inactive' }}">{{ 'Connected' if env.opencti_token else 'No Token' }}</span>
        </div>

        <div class="integration-card">
            <div class="integration-card-name">GitLab</div>
            <div class="integration-card-url">{{ env.gitlab_url }}</div>
            <span class="integration-card-status status-{{ 'active' if env.gitlab_token else 'inactive' }}">{{ 'Connected' if env.gitlab_token else 'No Token' }}</span>
        </div>

        <div class="integration-card">
            <div class="integration-card-name">Logging</div>
            <div class="integration-card-url">Rule log export to SIEM</div>
            <span class="integration-card-status status-{{ 'active' if app_settings.get('rule_log_enabled', 'false') == 'true' else 'inactive' }}">{{ 'Enabled' if app_settings.get('rule_log_enabled', 'false') == 'true' else 'Disabled' }}</span>
        </div>
    </div>
</div>

<!-- ═══ Repositories ═══ -->
<div class="overview-section">
    <h2>{{ icon('github', '20') }} Repositories</h2>
    <div class="metrics-grid">
        <div class="integration-card">
            <div class="integration-card-name">MITRE Enterprise ATT&amp;CK</div>
            <div class="integration-card-url" title="{{ env.mitre_source }}">{{ env.mitre_source | truncate(50, True, '...') }}</div>
            <span class="integration-card-status status-{{ 'active' if repo_status.mitre_enterprise else 'inactive' }}">{{ 'Active' if repo_status.mitre_enterprise else 'Missing' }}</span>
        </div>

        <div class="integration-card">
            <div class="integration-card-name">MITRE Mobile ATT&amp;CK</div>
            <div class="integration-card-url" title="{{ env.mitre_mobile_source }}">{{ env.mitre_mobile_source | truncate(50, True, '...') }}</div>
            <span class="integration-card-status status-{{ 'active' if repo_status.mitre_mobile else 'inactive' }}">{{ 'Active' if repo_status.mitre_mobile else 'Missing' }}</span>
        </div>

        <div class="integration-card">
            <div class="integration-card-name">MITRE ICS ATT&amp;CK</div>
            <div class="integration-card-url" title="{{ env.mitre_ics_source }}">{{ env.mitre_ics_source | truncate(50, True, '...') }}</div>
            <span class="integration-card-status status-{{ 'active' if repo_status.mitre_ics else 'inactive' }}">{{ 'Active' if repo_status.mitre_ics else 'Missing' }}</span>
        </div>

        <div class="integration-card">
            <div class="integration-card-name">MITRE PRE-ATT&amp;CK</div>
            <div class="integration-card-url" title="{{ env.mitre_pre_source }}">{{ env.mitre_pre_source | truncate(50, True, '...') }}</div>
            <span class="integration-card-status status-{{ 'active' if repo_status.mitre_pre else 'inactive' }}">{{ 'Active' if repo_status.mitre_pre else 'Missing' }}</span>
        </div>

        <div class="integration-card">
            <div class="integration-card-name">Sigma Rules</div>
            <div class="integration-card-url" title="{{ env.sigma_repo_url }}">{{ env.sigma_repo_url | truncate(50, True, '...') }}</div>
            <span class="integration-card-status status-{{ 'active' if repo_status.sigma else 'inactive' }}">{{ 'Cloned' if repo_status.sigma else 'Not Found' }}</span>
        </div>

        <div class="integration-card">
            <div class="integration-card-name">Elastic Detection Rules</div>
            <div class="integration-card-url" title="{{ env.elastic_repo_url }}">{{ env.elastic_repo_url | truncate(50, True, '...') }}</div>
            <span class="integration-card-status status-{{ 'active' if repo_status.elastic_detection else 'inactive' }}">{{ 'Cloned' if repo_status.elastic_detection else 'Not Found' }}</span>
        </div>
    </div>
</div>

{% endblock %}
