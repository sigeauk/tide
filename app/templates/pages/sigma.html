{% extends "base.html" %}
{% from "macros/icons.html" import icon, icon_text %}

{% block title %}Sigma Convert | TIDE{% endblock %}

{% block head %}
<!-- CodeMirror for YAML editing with syntax highlighting (bundled locally) -->
<link rel="stylesheet" href="/static/css/vendor/codemirror.min.css">
<link rel="stylesheet" href="/static/css/vendor/codemirror-material-darker.min.css">
<script defer src="/static/js/vendor/codemirror.min.js"></script>
<script defer src="/static/js/vendor/codemirror-yaml.min.js"></script>
<!-- Prism.js for JSON output highlighting (bundled locally) -->
<link rel="stylesheet" href="/static/css/vendor/prism-tomorrow.min.css">
<script defer src="/static/js/vendor/prism.min.js"></script>
<script defer src="/static/js/vendor/prism-json.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title-hero" style="font-size: 2rem; margin-bottom: 0.25rem;">
        Sigma Converter
    </h1>
    <p class="page-subtitle">Convert Sigma detection rules into SIEM-specific queries for deployment.</p>
</div>

<!-- Compact horizontal selects -->
<div class="sigma-header-row">
    <div class="sigma-select-group">
        <label>Target</label>
        <select id="backend-select" class="sigma-select">
            {% for key, label in backends.items() %}
            <option value="{{ key }}" {% if key == 'elasticsearch' %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="sigma-select-group">
        <label>Format</label>
        <select id="format-select" class="sigma-select">
            {% for key, label in formats.items() %}
            <option value="{{ key }}">{{ label }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="sigma-select-group">
        <label>Pipeline</label>
        <select id="pipeline-select" class="sigma-select" style="min-width: 180px;">
            {% for key, label in pipelines.items() %}
            <option value="{{ key }}">{{ label }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Collapsible Rule Browser -->
<div class="rule-browser" id="rule-browser">
    <div class="rule-browser-header" onclick="toggleRuleBrowser()">
        <span>{{ icon('search', '16') }} Rule Browser</span>
        <svg class="rule-browser-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </div>
    <div class="rule-browser-content">
        <div class="browser-filters">
            <div class="browser-filter" style="flex: 2;">
                <label>Search</label>
                <input type="text" id="rule-search" 
                       placeholder="Title, description, technique..."
                       hx-get="/api/sigma/rules"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#rules-list"
                       hx-include="#rule-search, #technique-filter, #category-filter, #level-filter"
                       name="q">
            </div>
            <div class="browser-filter">
                <label>MITRE Technique</label>
                <input type="text" id="technique-filter" 
                       placeholder="e.g., T1059"
                       hx-get="/api/sigma/rules"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#rules-list"
                       hx-include="#rule-search, #technique-filter, #category-filter, #level-filter"
                       name="technique"
                       value="{{ technique_filter }}">
            </div>
            <div class="browser-filter">
                <label>Category</label>
                <select id="category-filter"
                        hx-get="/api/sigma/rules"
                        hx-trigger="change"
                        hx-target="#rules-list"
                        hx-include="#rule-search, #technique-filter, #category-filter, #level-filter"
                        name="category">
                    <option value="">All</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat | title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="browser-filter">
                <label>Level</label>
                <select id="level-filter"
                        hx-get="/api/sigma/rules"
                        hx-trigger="change"
                        hx-target="#rules-list"
                        hx-include="#rule-search, #technique-filter, #category-filter, #level-filter"
                        name="level">
                    <option value="">All</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                    <option value="informational">Info</option>
                </select>
            </div>
        </div>
        <div id="rules-list">
            {% include "partials/sigma_rules_list.html" %}
        </div>
    </div>
</div>

<!-- Main two-column layout (Symmetric Mirror) -->
<div class="sigma-main">
    <!-- Left: YAML Editor Panel -->
    <div class="sigma-panel">
        <div class="sigma-panel-header">
            <span class="header-title">{{ icon('file-text', '16') }} rule.yml</span>
        </div>
        
        <!-- Panel Body: Code Area -->
        <div class="sigma-panel-body">
            <form id="convert-form" hx-post="/api/sigma/convert" hx-target="#query-output-container" hx-swap="innerHTML" class="sigma-form-body">
                <div class="code-editor-container">
                    <textarea 
                        id="yaml-editor" 
                        name="yaml_content"
                        class="yaml-editor"
                        spellcheck="false"
                        placeholder="title: Example Rule
id: 12345678-1234-1234-1234-123456789abc
status: experimental
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        CommandLine|contains: 'suspicious'
    condition: selection
level: medium"></textarea>
                </div>
                
                <!-- Hidden fields for form submission -->
                <input type="hidden" id="form-backend" name="backend" value="elasticsearch">
                <input type="hidden" id="form-pipeline" name="pipeline" value="none">
                <input type="hidden" id="form-format" name="output_format" value="kibana_ndjson">
            </form>
            <div id="validation-result"></div>
        </div>
        
        <!-- Left Footer: Action Buttons -->
        <div class="sigma-panel-footer">
            <button type="submit" form="convert-form" class="btn btn-primary btn-sm">
                {{ icon_text('refresh-cw', 'Convert', '14') }}
            </button>
            <button type="button" class="btn btn-secondary btn-sm" 
                    hx-post="/api/sigma/validate"
                    hx-target="#validation-result"
                    hx-include="#yaml-editor">
                {{ icon_text('check-circle', 'Validate', '14') }}
            </button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="clearYamlEditor()">
                {{ icon_text('trash-2', 'Clear', '14') }}
            </button>
        </div>
    </div>
    
    <!-- Right: Query Output Panel (Mirror of Left) -->
    <div class="sigma-panel">
        <div class="sigma-panel-header">
            <span class="header-title">{{ icon('zap', '16') }} Query Output</span>
            <span class="header-info" id="output-info" style="display: none;">
                {{ icon('info', '12') }}
                <span id="output-info-text"></span>
            </span>
        </div>
        
        <!-- Panel Body: Output Area -->
        <div class="sigma-panel-body">
            <div id="query-output-container">
                <div class="query-output-box">
                    <div class="empty-output">
                        {{ icon('terminal', '32') }}
                        <p>Select a rule or paste YAML, then click Convert</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Footer: Deploy Controls (Single Line, Right-Aligned) -->
        <div class="sigma-panel-footer footer-right" id="deploy-footer">
            <form id="deploy-form" hx-post="/api/sigma/deploy" hx-target="#deploy-result" hx-swap="innerHTML" class="sigma-deploy-form">
                <input type="hidden" name="yaml_content" id="deploy-yaml">
                <input type="hidden" name="raw_query" id="deploy-query">
                
                <button type="button" class="btn btn-secondary btn-sm" onclick="downloadQuery()">
                    {{ icon_text('download', 'Download', '14') }}
                </button>
                
                <div class="filter-group">
                    <label>Space</label>
                    <select name="space">
                        <option value="staging">Staging</option>
                        <option value="production">Production</option>
                    </select>
                </div>
                
                <label class="checkbox-group">
                    <input type="checkbox" name="enabled" value="true">
                    <span>Enable</span>
                </label>
                
                <button type="submit" class="btn btn-primary btn-sm" onclick="prepareDeployForm()">
                    {{ icon_text('rocket', 'Deploy', '14') }}
                </button>
            </form>
        </div>
        <div id="deploy-result"></div>
    </div>
</div>

<script>
// Clean up any stale state from previous page visits
// HTMX navigation means the old DOM is gone but window.sigmaYamlEditor may still reference it
if (window.sigmaYamlEditor) {
    console.log('[Sigma] Cleaning up stale CodeMirror reference');
    window.sigmaYamlEditor = null;
}

// Initialize Sigma page components - exposed globally for HTMX re-initialization
window.initSigmaPage = function(retryCount = 0) {
    const maxRetries = 50;  // Up to 5 seconds of retrying
    
    // Check if CodeMirror AND yaml mode are both loaded
    if (typeof CodeMirror === 'undefined' || !CodeMirror.modes || !CodeMirror.modes.yaml) {
        if (retryCount < maxRetries) {
            console.debug(`[Sigma] CodeMirror/YAML mode not loaded yet, retry ${retryCount + 1}/${maxRetries}...`);
            setTimeout(() => window.initSigmaPage(retryCount + 1), 100);
        } else {
            console.error('[Sigma] CodeMirror failed to load after multiple retries');
        }
        return;
    }
    
    const yamlTextarea = document.getElementById('yaml-editor');
    if (!yamlTextarea) {
        console.debug('[Sigma] yaml-editor not found, page may not be ready');
        return;
    }
    
    // ALWAYS create fresh CodeMirror for HTMX navigations
    // Check if textarea is hidden (CodeMirror already attached)
    if (yamlTextarea.style.display === 'none' || yamlTextarea.nextElementSibling?.classList.contains('CodeMirror')) {
        const existingWrapper = yamlTextarea.nextElementSibling;
        if (existingWrapper && existingWrapper.classList.contains('CodeMirror')) {
            const cm = existingWrapper.CodeMirror;
            if (cm) {
                window.sigmaYamlEditor = cm;
                // Force mode refresh
                cm.setOption('mode', 'yaml');
                cm.refresh();
                setTimeout(() => cm.refresh(), 100);
                setTimeout(() => cm.refresh(), 300);
                console.log('[Sigma] Reused existing CodeMirror instance, forced mode refresh');
                return;
            } else {
                // Orphaned wrapper - remove it
                console.warn('[Sigma] Found orphaned CodeMirror wrapper, removing...');
                existingWrapper.remove();
                yamlTextarea.style.display = '';
            }
        }
    }
    
    console.log('[Sigma] Creating NEW CodeMirror instance...');
    
    // Initialize CodeMirror
    const yamlEditor = CodeMirror.fromTextArea(yamlTextarea, {
        mode: 'yaml',
        theme: 'material-darker',
        lineNumbers: true,
        lineWrapping: true,
        tabSize: 2,
        indentWithTabs: false,
        autofocus: false
    });
    
    // Store reference for global access
    window.sigmaYamlEditor = yamlEditor;
    
    // Force multiple refreshes to ensure syntax highlighting is applied
    // This handles race conditions with CSS loading
    setTimeout(() => yamlEditor.refresh(), 50);
    setTimeout(() => yamlEditor.refresh(), 200);
    setTimeout(() => yamlEditor.refresh(), 500);
    
    // Sync CodeMirror content to textarea on change (for form submission)
    yamlEditor.on('change', function() {
        yamlTextarea.value = yamlEditor.getValue();
    });
    
    console.log('[Sigma] CodeMirror initialized successfully');
    
    // Auto-open if there's a technique filter
    {% if technique_filter %}
    const ruleBrowser = document.getElementById('rule-browser');
    if (ruleBrowser) ruleBrowser.classList.add('open');
    {% endif %}
    
    // Sync select values to hidden form fields
    const backendSelect = document.getElementById('backend-select');
    const formatSelect = document.getElementById('format-select');
    const pipelineSelect = document.getElementById('pipeline-select');
    
    if (backendSelect) {
        backendSelect.addEventListener('change', function() {
            const backend = this.value;
            document.getElementById('form-backend').value = backend;
            
            // Fetch new format options for this backend
            fetch(`/api/sigma/formats/${backend}`)
                .then(response => response.text())
                .then(html => {
                    const formatSelect = document.getElementById('format-select');
                    formatSelect.innerHTML = html;
                    const firstOption = formatSelect.options[0];
                    if (firstOption) {
                        document.getElementById('form-format').value = firstOption.value;
                    }
                })
                .catch(err => console.error('Failed to load formats:', err));
        });
    }
    
    if (formatSelect) {
        formatSelect.addEventListener('change', function() {
            document.getElementById('form-format').value = this.value;
        });
    }
    
    if (pipelineSelect) {
        pipelineSelect.addEventListener('change', function() {
            document.getElementById('form-pipeline').value = this.value;
        });
    }
    
    console.log('[Sigma] Sigma page initialized');
};

// Initialize immediately on page load
console.log('[Sigma] Script block executing, calling initSigmaPage...');
window.initSigmaPage();

// Toggle rule browser (global for onclick)
window.toggleRuleBrowser = function() {
    document.getElementById('rule-browser').classList.toggle('open');
};

// Load rule YAML into editor (global for onclick)
window.loadRuleYaml = function(ruleId) {
    const editor = window.sigmaYamlEditor;
    if (!editor) {
        console.error('YAML editor not initialized');
        return;
    }
    
    fetch(`/api/sigma/rule/${ruleId}`)
        .then(response => response.text())
        .then(yaml => {
            editor.setValue(yaml);
            // Force refresh to ensure syntax highlighting is applied
            setTimeout(() => editor.refresh(), 10);
            document.getElementById('query-output-container').innerHTML = `
                <div class="query-output-box">
                    <div class="empty-output">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></svg>
                        <p>Click Convert to generate the query</p>
                    </div>
                </div>
            `;
            document.getElementById('validation-result').innerHTML = '';
        })
        .catch(err => console.error('Failed to load rule:', err));
};

// Clear YAML editor (global for onclick)
window.clearYamlEditor = function() {
    const editor = window.sigmaYamlEditor;
    if (!editor) return;
    
    editor.setValue('');
    document.getElementById('query-output-container').innerHTML = `
        <div class="query-output-box">
            <div class="empty-output">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></svg>
                <p>Select a rule or paste YAML, then click Convert</p>
            </div>
        </div>
    `;
    document.getElementById('validation-result').innerHTML = '';
};
</script>

<!-- Slide panel for technique details -->
<div id="slide-panel-container"></div>
{% endblock %}
